version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # INFRASTRUCTURE LAYER
  # ---------------------------------------------------------------------------

  # 1. PostgreSQL (Metadata & MLflow Backend)
  # Commented out - not needed for video ingestion testing
  # db:
  #   image: postgres:15-alpine
  #   container_name: vid_analytics_db
  #   restart: always
  #   environment:
  #     POSTGRES_USER: ${POSTGRES_USER}
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
  #     POSTGRES_DB: ${POSTGRES_DB}
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - db_data:/var/lib/postgresql/data
  #   networks:
  #     - analytics_network

  # 2. Redis (Message Queue)
  redis:
    image: redis:7-alpine
    container_name: vid_analytics_queue
    restart: always
    ports:
      - "6379:6379"
    networks:
      - analytics_network

  # 3. MinIO (Unified Object Storage - replaces Local Storage)
  minio:
    image: minio/minio
    container_name: vid_analytics_storage
    restart: always
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    ports:
      - "9000:9000" # API Port
      - "9001:9001" # Console Port
    volumes:
      - minio_data:/data
    networks:
      - analytics_network
  # 4. MinIO Setup (One-off task to create buckets automatically)
  # Commented out - ingestion.py creates buckets automatically if needed
  # createbuckets:
  #   image: minio/mc
  #   depends_on:
  #     - minio
  #   entrypoint: >
  #     /bin/sh -c " /usr/bin/mc alias set myminio http://minio:9000 minioadmin minioadmin; /usr/bin/mc mb myminio/raw-frames; /usr/bin/mc mb myminio/processed-images; /usr/bin/mc mb myminio/mlflow-models; /usr/bin/mc admin policy set myminio download public; exit 0; "
  #   networks:
  #     - analytics_network

  # 5. MLflow Tracking Server
  # Commented out - not needed for video ingestion testing
  # mlflow:
  #   image: ghcr.io/mlflow/mlflow:v2.7.1
  #   container_name: vid_analytics_mlflow
  #   restart: always
  #   depends_on:
  #     - db
  #     - minio
  #   environment:
  #     MLFLOW_S3_ENDPOINT_URL: http://minio:9000
  #     AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
  #     AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
  #   command: >
  #     mlflow server --backend-store-uri ${DB_URI} --default-artifact-root s3://mlflow-models/ --host 0.0.0.0
  #   ports:
  #     - "5000:5000"
  #   networks:
  #     - analytics_network

  # ---------------------------------------------------------------------------
  # APPLICATION LAYER (Your Custom Services)
  # ---------------------------------------------------------------------------

  # A. Video Ingestion Service
  ingestion-service:
    build: ./ingestion
    container_name: vid_ingestion
    restart: on-failure
    depends_on:
      - redis
      - minio
    environment:
      VIDEO_FILE: /app/sample_videos/truck_highway_short.mp4
      CAMERA_ID: docker_camera_01
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      REDIS_QUEUE_NAME: frame_batches
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET_NAME: video-frames
      MINIO_SECURE: "false"
    volumes:
      - ./ingestion/sample_videos:/app/sample_videos:ro
    networks:
      - analytics_network
  # B. Processing Worker (Scalable: docker-compose up --scale worker=3)
  # Commented out - not implemented yet
  # processing-worker:
  #   build: ./worker # Point to your worker code folder
  #   container_name: vid_worker
  #   restart: on-failure
  #   deploy:
  #     resources:
  #       reservations:
  #         devices:
  #           - driver: nvidia
  #             count: 1
  #             capabilities: [ gpu ]
  #   depends_on:
  #     - redis
  #     - minio
  #     - db
  #     - mlflow
  #   environment:
  #     REDIS_HOST: redis
  #     DB_URI: ${DB_URI}
  #     MLFLOW_TRACKING_URI: http://mlflow:5000
  #   networks:
  #     - analytics_network
  # C. Backend API (Decouples Dashboard from DB)
  # backend-api:
  #   build: ./backend # Point to your FastAPI/Node code
  #   container_name: vid_api
  #   restart: always
  #   ports:
  #     - "8080:8080"
  #   depends_on:
  #     - db
  #     - minio
  #   environment:
  #     DB_URI: ${DB_URI}
  #     MINIO_ENDPOINT: minio:9000
  #   networks:
  #     - analytics_network

  # D. Dashboard (Frontend)
  # dashboard:
  #   build: ./dashboard # React/Vue/Streamlit app
  #   container_name: vid_dashboard
  #   ports:
  #     - "3000:3000"
  #   depends_on:
  #     - backend-api
  #   networks:
  #     - analytics_network

  # ---------------------------------------------------------------------------
  # VOLUMES & NETWORKS
  # ---------------------------------------------------------------------------
volumes:
  # db_data:  # Commented out - db service not in use
  minio_data:


networks:
  analytics_network:
    driver: bridge
