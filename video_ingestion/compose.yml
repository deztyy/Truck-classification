# =============================================================================
# VIDEO INGESTION SUBSYSTEM - LOCAL VIDEO TEST VERSION
# Handles local video file processing and frame preprocessing
# =============================================================================

services:
  # --- Redis Message Broker ---
  redis_broker:
    image: redis:alpine
    container_name: redis_broker
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1GB
        reservations:
          cpus: '0.25'
          memory: 256MB
    restart: always
    ports:
      - "6379:6379"
    networks:
      truck_system_network:
        aliases:
          - redis  # ✅ เพิ่ม alias เพื่อให้เข้าถึงได้ทั้ง redis และ redis_broker
    command: >
      redis-server
      --maxmemory 768mb
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --- Local Video Worker ---
  video_test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: worker_video_test
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2GB
        reservations:
          cpus: '1.0'
          memory: 1GB
    restart: always
    depends_on:
      redis_broker:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis_broker  # ✅ ชัดเจนว่าใช้ redis_broker
      - REDIS_PORT=6379
      - OUTPUT_FOLDER=/app/shared_memory
      - CAMERA_ID=VIDEO_TEST
      - VIDEO_PATH=/app/videos/testvid_1.mp4
      - LOOP_VIDEO=true
      
      # Processing Parameters
      - PROCESS_FPS=2.0
      - BATCH_SIZE=30
      - TARGET_WIDTH=640
      - TARGET_HEIGHT=640
      - JPG_QUALITY=85
      - RETENTION_SECONDS=3600
      
      # Performance optimizations
      - PYTHONUNBUFFERED=1
      - OMP_NUM_THREADS=2
    volumes:
      - ../shared_data:/app/shared_memory
      - ./test_videos:/app/videos:ro
    networks:
      - truck_system_network
    tmpfs:
      - /tmp:size=512M,mode=1777

# Network configuration
networks:
  truck_system_network:
    name: truck_system_network
    external: true

# =============================================================================
# NOTES:
# - Redis service has two network aliases: 'redis_broker' and 'redis'
# - Services can connect using either hostname
# - Recommended to use 'redis_broker' for clarity
# =============================================================================