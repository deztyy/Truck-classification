version: '3.8'

services:
  # --- Service 1: Redis (‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô) ---
  redis_broker:
    image: redis:alpine
    container_name: redis_broker
    restart: always
    ports:
      - "6379:6379"
    networks:
      - video_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --- Service 2: ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 1 ---
  cam_01:
    build: .
    container_name: worker_cam_01
    restart: always  # ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡∏ñ‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° Error ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏∏‡∏î ‡∏°‡∏±‡∏ô‡∏à‡∏∞ Restart ‡πÄ‡∏≠‡∏á
    depends_on:
      redis_broker:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis_broker
      - REDIS_PORT=6379
      - OUTPUT_FOLDER=/app/shared_memory
      - CAMERA_ID=CAM_001
      # üëá ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      - RTSP_URL=rtsp://admin:Smarterware2025@stwcctv.autoddns.com:554/chID=1
    volumes:
      - ./data_output:/app/shared_memory  # Map ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Host
    networks:
      - video_network

  # --- Service 3: ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 2 ---
  cam_02:
    build: .
    container_name: worker_cam_02
    restart: always
    depends_on:
      redis_broker:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis_broker
      - REDIS_PORT=6379
      - OUTPUT_FOLDER=/app/shared_memory
      - CAMERA_ID=CAM_002
      # üëá ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      - RTSP_URL=rtsp://admin:Smarterware2025@stwcctv.autoddns.com:554/chID=2
    volumes:
      - ./data_output:/app/shared_memory
    networks:
      - video_network

  # --- Service 4: ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 3 ---
  cam_03:
    build: .
    container_name: worker_cam_03
    restart: always
    depends_on:
      redis_broker:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis_broker
      - REDIS_PORT=6379
      - OUTPUT_FOLDER=/app/shared_memory
      - CAMERA_ID=CAM_003
      # üëá ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      - RTSP_URL=rtsp://admin:Smarterware2025@stwcctv.autoddns.com:554/chID=3
    volumes:
      - ./data_output:/app/shared_memory
    networks:
      - video_network

# ‡∏™‡∏£‡πâ‡∏≤‡∏á Network ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ
networks:
  video_network:
    driver: bridge